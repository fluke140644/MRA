{% extends "baseipd.html" %}
{% load mra_extras %}
<title>{% block title %}สรุปค่าเฉลี่ยรายเกณฑ์ OPD{% endblock %}</title>

{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="m-0" style="font-size: 24px; font-weight: bold; z-index: 1;">สรุปค่าเฉลี่ยรายเกณฑ์ (OPD)</h3>
    <div class="d-flex gap-2 d-print-none">
      <a href="{% url 'MRA:opd_score_list' %}" class="btn btn-outline-secondary">ย้อนกลับ</a>
      <!-- <button class="btn btn-outline-primary" onclick="window.print()">พิมพ์</button> -->
    </div>
  </div>

  <form method="get" class="row g-2 align-items-end justify-content-end mb-3 d-print-none">
    <div class="col-auto">
      <label class="form-label mb-1">ช่วงตรวจ (YYYY-MM)</label>
      <input type="month" name="period" value="{{ period }}" class="form-control">
    </div>
    <div class="col-auto">
      <label class="form-label mb-1">ค้นหา (HN/PID/Hcode/Hname)</label>
      <input type="text" name="q" value="{{ q }}" class="form-control" placeholder="เช่น 4913989 หรือ 11087">
    </div>
    <div class="col-auto">
      <button class="btn btn-primary">กรอง</button>
      <a class="btn btn-outline-secondary" href="{% url 'MRA:opd_score_averages' %}">ล้าง</a>
    </div>
  </form>

  <div class="table-responsive">
    <table class="table table-sm table-bordered align-middle">
      <thead class="table-warning text-center">
        <tr>
          <th style="width:220px;">หัวข้อ</th>
          {% for j in item_numbers %}
            <th>เกณฑ์ {{ j }}</th>
          {% endfor %}
          <th class="bg-warning" style="width:110px;">เฉลี่ยหัวข้อ</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
          <tr>
            <th class="text-start">{{ r.title }}</th>
            {% for c in r.cols %}
              <td class="text-center">{{ c.percent }}</td>
            {% endfor %}
            <td class="text-center fw-bold bg-warning-subtle">{{ r.avg }}</td>
          </tr>
        {% endfor %}
      </tbody>
      <tfoot>
        <tr class="table-light">
          <th class="text-start bg-secondary-subtle">Total</th>
          {% for c in total_row.cols %}
            <th class="text-center">{{ c.percent }}</th>
          {% endfor %}
          <th class="text-center bg-secondary-subtle">{{ total_row.avg }}</th>
        </tr>
      </tfoot>
    </table>
  </div>

  <div class="card mt-4">
  <div class="card-body">
    <h5 class="mb-3">กราฟค่าเฉลี่ย (OPD)</h5>

    <div class="row g-4">
      <div class="col-lg-6">
        <h6 class="text-muted mb-2">ค่าเฉลี่ยต่อเกณฑ์ (รวมทุกหัวข้อ)</h6>
        <div style="height:320px">
          <canvas id="avgByCriterionChart"></canvas>
        </div>
      </div>
      <div class="col-lg-6">
        <h6 class="text-muted mb-2">ค่าเฉลี่ยต่อหัวข้อ</h6>
        <div style="height:320px">
          <canvas id="avgBySectionChart"></canvas>
        </div>
      </div>
    </div>

    <hr class="my-4">

    <div class="row g-3 align-items-center">
      <div class="col-auto">
        <label class="col-form-label">ดูรายละเอียดเกณฑ์ตามหัวข้อ</label>
      </div>
      <div class="col-auto">
        <select id="sectionSelect" class="form-select form-select-sm">
          {% for r in rows %}
            <option value="{{ forloop.counter0 }}">{{ r.title }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
    <div class="mt-3" style="height:340px">
      <canvas id="sectionDetailChart"></canvas>
    </div>
  </div>
</div>

  <!-- <div class="text-muted small">
    * หัวข้อที่ถูก “ล็อค” จะไม่นับในตัวหาร (0/0).<br>
    * หัวข้อ 5 (Follow Up) รวมข้อมูลจากครั้งที่ 1–3 ในการคำนวณ.
  </div> -->
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(() => {
  // ===== เตรียมข้อมูลจาก context =====
  const itemLabels = [{% for j in item_numbers %}"เกณฑ์ {{ j }}"{% if not forloop.last %}, {% endif %}{% endfor %}];

  const totalPercents = [{% for c in total_row.cols %}{{ c.percent|default:'0' }}{% if not forloop.last %}, {% endif %}{% endfor %}];

  const sectionLabels = [{% for r in rows %}"{{ r.title|escapejs }}"{% if not forloop.last %}, {% endif %}{% endfor %}];
  const sectionAvgs   = [{% for r in rows %}{{ r.avg|default:'0' }}{% if not forloop.last %}, {% endif %}{% endfor %}];

  // เมทริกซ์เปอร์เซ็นต์: แถว = หัวข้อ, คอลัมน์ = เกณฑ์ 1..7
  const sectionsMatrix = [
    {% for r in rows %}
      [{% for c in r.cols %}{{ c.percent|default:'0' }}{% if not forloop.last %}, {% endif %}{% endfor %}]
      {% if not forloop.last %}, {% endif %}
    {% endfor %}
  ];

  const commonOpts = {
    responsive: true,
    maintainAspectRatio: false,
    scales: {
      y: {
        beginAtZero: true,
        suggestedMax: 100,
        ticks: { callback: (v) => v + '%' }
      }
    },
    plugins: {
      legend: { display: false },
      tooltip: {
        callbacks: {
          label: (ctx) => (ctx.parsed.y ?? ctx.parsed) + '%'
        }
      }
    }
  };

  // ===== Chart 1: ค่าเฉลี่ยต่อเกณฑ์ (รวมทุกหัวข้อ) =====
  const ctx1 = document.getElementById('avgByCriterionChart').getContext('2d');
  const avgByCriterionChart = new Chart(ctx1, {
    type: 'bar',
    data: {
      labels: itemLabels,
      datasets: [{ data: totalPercents }]
    },
    options: commonOpts
  });

  // ===== Chart 2: ค่าเฉลี่ยต่อหัวข้อ =====
  const ctx2 = document.getElementById('avgBySectionChart').getContext('2d');
  const avgBySectionChart = new Chart(ctx2, {
    type: 'bar',
    data: {
      labels: sectionLabels,
      datasets: [{ data: sectionAvgs }]
    },
    options: commonOpts
  });

  // ===== Chart 3: เลือกหัวข้อ ดูค่าเฉลี่ยเกณฑ์ 1–7 =====
  const detailEl = document.getElementById('sectionDetailChart').getContext('2d');
  const sectionSelect = document.getElementById('sectionSelect');

  const detailChart = new Chart(detailEl, {
    type: 'bar',
    data: {
      labels: itemLabels,
      datasets: [{ data: sectionsMatrix[0] || [] }]
    },
    options: commonOpts
  });

  sectionSelect.addEventListener('change', () => {
    const idx = parseInt(sectionSelect.value, 10) || 0;
    detailChart.data.datasets[0].data = sectionsMatrix[idx] || [];
    detailChart.update();
  });
})();
</script>
{% endblock %}
