{% extends "baseipd.html" %}
{% load static %}

{% block content %}
<div class="container py-4">
  <div class="d-flex flex-wrap gap-2 justify-content-between align-items-end mb-3">
    <h3 class="m-0" style="font-size: 24px; font-weight: bold; z-index: 1;">ภาพรวมแต่ละเกณฑ์รายเกณฑ์</h3>

    <form class="d-flex gap-2" method="get">
      <input type="text" name="q" value="{{ q }}" 
       class="form-control" style="min-width: 400px;"
       placeholder="เช่น 09/09/2025 หรือ 01/09/2025 - 10/09/2025">
      <button class="btn btn-primary" type="submit">ค้นหา</button>
      <a class="btn btn-outline-secondary" href="{% url 'MRA:score_summary' %}">ล้าง</a>
    </form>
  </div>

  <div class="table-responsive">
    <table class="table table-bordered table-sm align-middle">
      <thead class="table-warning text-center">
        <tr>    
          <th style="white-space:nowrap;">หัวข้อ</th>
          {% for k in "123456789" %}
            <th>เกณฑ์ข้อ {{ forloop.counter }}</th>
          {% endfor %}
          <th class="bg-warning text-dark">เฉลี่ย</th>
        </tr>
      </thead>
      <tbody>
        {% for row in rows %}
          <tr>
            <th class="bg-light" style="white-space:nowrap;">{{ row.index }}. {{ row.title }}</th>
            {% for c in row.cols %}
              <td class="text-end">{{ c.percent|floatformat:2 }}</td>
            {% endfor %}
            <td class="text-end fw-bold bg-warning-subtle">{{ row.avg|floatformat:2 }}</td>
          </tr>
        {% endfor %}
        <tr class="fw-bold">
          <th class="bg-secondary-subtle">Total</th>
          {% for c in total_cols %}
            <td class="text-end">{{ c.percent|floatformat:2 }}</td>
          {% endfor %}
          <td class="text-end bg-secondary-subtle">{{ total_avg|floatformat:2 }}</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h3 class="mt-4 mb-3" style="font-size: 24px; font-weight: bold; z-index: 1;">แสดงผลเป็นกราฟแท่ง</h3>
<div class="card p-3 shadow-sm">
  <canvas id="summaryChart" height="640"></canvas>
</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const labels = [{% for row in rows %}"{{ row.index }}. {{ row.title }}",{% endfor %}];

  // เฉลี่ยรายแถว (ใช้ค่า row.avg)
  const dataAvg = [{% for row in rows %}{{ row.avg|floatformat:2 }},{% endfor %}];

  const ctx = document.getElementById('summaryChart').getContext('2d');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'ร้อยละเฉลี่ย (%)',
        data: dataAvg,
        backgroundColor: 'rgba(54, 162, 235, 0.7)',
        borderColor: 'rgba(54, 162, 235, 1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: true },
        tooltip: { enabled: true }
      },
      scales: {
        y: {
          beginAtZero: true,
          max: 100,
          title: { display: true, text: 'เปอร์เซ็นต์ (%)' }
        },
        x: {
          ticks: { autoSkip: false, maxRotation: 45, minRotation: 30 }
        }
      }
    }
  });
</script>


  <!-- <p class="text-muted mt-2">
    หมายเหตุ: คำนวณ % = จำนวน “1” / (จำนวนช่องที่ไม่นับ “NA”) × 100
  </p> -->
  
</div>
{% endblock %}
