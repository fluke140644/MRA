{% extends "baseipd.html" %}
{% load static %}

{% block content %}
<div class="container py-4">
  <div class="d-flex flex-wrap gap-2 justify-content-between align-items-end mb-3">
    <h3 class="m-0" style="font-size: 24px; font-weight: bold; z-index: 1;">ภาพรวมแต่ละเกณฑ์รายเกณฑ์</h3>

    <form class="d-flex gap-2" method="get">
      <input type="text" name="q" value="{{ q }}" 
       class="form-control" style="min-width: 400px;"
       placeholder="เช่น 09/09/2025 หรือ 01/09/2025 - 10/09/2025">
      <button class="btn btn-primary" type="submit">ค้นหา</button>
      <a class="btn btn-outline-secondary" href="{% url 'MRA:score_summary' %}">ล้าง</a>
    </form>
  </div>

  <div class="table-responsive">
    <table class="table table-bordered table-sm align-middle">
      <thead class="table-warning text-center">
        <tr>    
          <th style="white-space:nowrap;">หัวข้อ</th>
          {% for k in "123456789" %}
            <th>เกณฑ์ข้อ {{ forloop.counter }}</th>
          {% endfor %}
          <th class="bg-warning text-dark">เฉลี่ย</th>
        </tr>
      </thead>
      <tbody>
        {% for row in rows %}
          <tr>
            <th class="bg-light" style="white-space:nowrap;">{{ row.index }}. {{ row.title }}</th>
            {% for c in row.cols %}
              <td class="text-end">{{ c.percent|floatformat:2 }}</td>
            {% endfor %}
            <td class="text-end fw-bold bg-warning-subtle">{{ row.avg|floatformat:2 }}</td>
          </tr>
        {% endfor %}
        <tr class="fw-bold">
          <th class="bg-secondary-subtle">Total</th>
          {% for c in total_cols %}
            <td class="text-end">{{ c.percent|floatformat:2 }}</td>
          {% endfor %}
          <td class="text-end bg-secondary-subtle">{{ total_avg|floatformat:2 }}</td>
        </tr>
      </tbody>
    </table>
  </div>

  <h3 class="mt-4 mb-3" style="font-size: 24px; font-weight: bold;">แสดงผลเป็นกราฟแท่ง</h3>
<div class="card p-3 shadow-sm">
  <div class="row g-4">
    <div class="col-lg-6">
      <h6 class="text-muted mb-2">ค่าเฉลี่ยต่อเกณฑ์ (รวมทุกหัวข้อ)</h6>
      <div style="height:320px"><canvas id="ipdAvgByCriterionChart"></canvas></div>
    </div>
    <div class="col-lg-6">
      <h6 class="text-muted mb-2">ค่าเฉลี่ยต่อหัวข้อ</h6>
      <div style="height:320px"><canvas id="ipdAvgBySectionChart"></canvas></div>
    </div>
  </div>

  <hr class="my-4">

  <div class="row g-3 align-items-center">
    <div class="col-auto">
      <label class="col-form-label">ดูรายละเอียดเกณฑ์ตามหัวข้อ</label>
    </div>
    <div class="col-auto">
      <select id="ipdSectionSelect" class="form-select form-select-sm">
        {% for row in rows %}
          <option value="{{ forloop.counter0 }}">{{ row.index }}. {{ row.title }}</option>
        {% endfor %}
      </select>
    </div>
  </div>
  <div class="mt-3" style="height:340px">
    <canvas id="ipdSectionDetailChart"></canvas>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(() => {
  // ----- เตรียมข้อมูลจาก context -----
  // ป้ายเกณฑ์ 1..9
  const itemLabels = [{% for k in "123456789" %}"เกณฑ์ {{ forloop.counter }}"{% if not forloop.last %}, {% endif %}{% endfor %}];

  // รวมทุกหัวข้อต่อเกณฑ์ (มาจาก total_cols)
  const totalPercents = [{% for c in total_cols %}{{ c.percent|default:'0' }}{% if not forloop.last %}, {% endif %}{% endfor %}];

  // ป้ายหัวข้อ + ค่าเฉลี่ยต่อหัวข้อ (row.avg)
  const sectionLabels = [{% for r in rows %}"{{ r.index }}. {{ r.title|escapejs }}"{% if not forloop.last %}, {% endif %}{% endfor %}];
  const sectionAvgs   = [{% for r in rows %}{{ r.avg|default:'0' }}{% if not forloop.last %}, {% endif %}{% endfor %}];

  // เมทริกซ์เปอร์เซ็นต์: แถว = หัวข้อ, คอลัมน์ = เกณฑ์ 1..9
  const sectionsMatrix = [
    {% for r in rows %}
      [{% for c in r.cols %}{{ c.percent|default:'0' }}{% if not forloop.last %}, {% endif %}{% endfor %}]
      {% if not forloop.last %}, {% endif %}
    {% endfor %}
  ];

  const commonOpts = {
    responsive: true,
    maintainAspectRatio: false,
    scales: {
      y: { beginAtZero: true, suggestedMax: 100, ticks: { callback: v => v + '%' } }
    },
    plugins: {
      legend: { display: false },
      tooltip: { callbacks: { label: ctx => (ctx.parsed.y ?? ctx.parsed) + '%' } }
    }
  };

  // 1) ค่าเฉลี่ยต่อเกณฑ์ (รวมทุกหัวข้อ)
  new Chart(document.getElementById('ipdAvgByCriterionChart').getContext('2d'), {
    type: 'bar',
    data: { labels: itemLabels, datasets: [{ data: totalPercents }] },
    options: commonOpts
  });

  // 2) ค่าเฉลี่ยต่อหัวข้อ
  new Chart(document.getElementById('ipdAvgBySectionChart').getContext('2d'), {
    type: 'bar',
    data: { labels: sectionLabels, datasets: [{ data: sectionAvgs }] },
    options: commonOpts
  });

  // 3) เลือกหัวข้อ → ดูค่าเฉลี่ยเกณฑ์ 1–9 ของหัวข้อนั้น
  const detailCtx = document.getElementById('ipdSectionDetailChart').getContext('2d');
  const selectEl  = document.getElementById('ipdSectionSelect');
  const detailChart = new Chart(detailCtx, {
    type: 'bar',
    data: { labels: itemLabels, datasets: [{ data: sectionsMatrix[0] || [] }] },
    options: commonOpts
  });
  selectEl.addEventListener('change', () => {
    const idx = parseInt(selectEl.value, 10) || 0;
    detailChart.data.datasets[0].data = sectionsMatrix[idx] || [];
    detailChart.update();
  });
})();
</script>
{% endblock %}
